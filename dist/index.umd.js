!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).VisitorTracker={})}(this,(function(t){"use strict";var e=function(){return e=Object.assign||function(t){for(var e,n=1,o=arguments.length;n<o;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t},e.apply(this,arguments)};function n(t,e,n,o){return new(n||(n=Promise))((function(r,i){function a(t){try{s(o.next(t))}catch(t){i(t)}}function c(t){try{s(o.throw(t))}catch(t){i(t)}}function s(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,c)}s((o=o.apply(t,e||[])).next())}))}function o(t,e){var n,o,r,i={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},a=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return a.next=c(0),a.throw=c(1),a.return=c(2),"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function c(c){return function(s){return function(c){if(n)throw new TypeError("Generator is already executing.");for(;a&&(a=0,c[0]&&(i=0)),i;)try{if(n=1,o&&(r=2&c[0]?o.return:c[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,c[1])).done)return r;switch(o=0,r&&(c=[2&c[0],r.value]),c[0]){case 0:case 1:r=c;break;case 4:return i.label++,{value:c[1],done:!1};case 5:i.label++,o=c[1],c=[0];continue;case 7:c=i.ops.pop(),i.trys.pop();continue;default:if(!(r=i.trys,(r=r.length>0&&r[r.length-1])||6!==c[0]&&2!==c[0])){i=0;continue}if(3===c[0]&&(!r||c[1]>r[0]&&c[1]<r[3])){i.label=c[1];break}if(6===c[0]&&i.label<r[1]){i.label=r[1],r=c;break}if(r&&i.label<r[2]){i.label=r[2],i.ops.push(c);break}r[2]&&i.ops.pop(),i.trys.pop();continue}c=e.call(t,i)}catch(t){c=[6,t],o=0}finally{n=r=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,s])}}}"function"==typeof SuppressedError&&SuppressedError;const r=[];for(let t=0;t<256;++t)r.push((t+256).toString(16).slice(1));let i;const a=new Uint8Array(16);var c={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function s(t,e,n){if(c.randomUUID&&!e&&!t)return c.randomUUID();const o=(t=t||{}).random??t.rng?.()??function(){if(!i){if("undefined"==typeof crypto||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");i=crypto.getRandomValues.bind(crypto)}return i(a)}();if(o.length<16)throw new Error("Random bytes length must be >= 16");if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,e){if((n=n||0)<0||n+16>e.length)throw new RangeError(`UUID byte range ${n}:${n+15} is out of buffer bounds`);for(let t=0;t<16;++t)e[n+t]=o[t];return e}return function(t,e=0){return(r[t[e+0]]+r[t[e+1]]+r[t[e+2]]+r[t[e+3]]+"-"+r[t[e+4]]+r[t[e+5]]+"-"+r[t[e+6]]+r[t[e+7]]+"-"+r[t[e+8]]+r[t[e+9]]+"-"+r[t[e+10]]+r[t[e+11]]+r[t[e+12]]+r[t[e+13]]+r[t[e+14]]+r[t[e+15]]).toLowerCase()}(o)}var u=36e5,l="first-visit",d="trk_first_visit",g=null,f=null,h=[],p={affiliateAttributionMode:l,cookieExpireDays:30,sessionTimeout:u,batchSendInterval:3e4,enableGeolocation:!0},m=function(t,e,n){var o=n||p.cookieExpireDays,r=new Date;r.setTime(r.getTime()+24*o*60*60*1e3),document.cookie="".concat(t,"=").concat(e,";expires=").concat(r.toUTCString(),";path=/;SameSite=Lax")},v=function(t){var e,n="; ".concat(document.cookie).split("; ".concat(t,"="));return 2===n.length&&(null===(e=n.pop())||void 0===e?void 0:e.split(";").shift())||""},w=function(){return n(void 0,void 0,void 0,(function(){var t;return o(this,(function(e){switch(e.label){case 0:return e.trys.push([0,3,,4]),[4,fetch("https://api.ipify.org?format=json")];case 1:return[4,e.sent().json()];case 2:return[2,e.sent().ip];case 3:return t=e.sent(),console.error("Failed to fetch user IP:",t),[2,"Unknown"];case 4:return[2]}}))}))},y=function(t){for(var e="Unknown",n="",o=0,r=[{name:"Chrome",regex:/Chrome\/([0-9.]+)/},{name:"Firefox",regex:/Firefox\/([0-9.]+)/},{name:"Safari",regex:/Safari\/([0-9.]+)/},{name:"Edge",regex:/Edge\/([0-9.]+)/},{name:"Opera",regex:/Opera\/([0-9.]+)/}];o<r.length;o++){var i=r[o],a=t.match(i.regex);if(a){e=i.name,n=a[1];break}}var c="Unknown";/Mobile|Android|iPhone/.test(t)?c="Mobile":/iPad|Tablet/.test(t)?c="Tablet":/Mobile|Android|iPhone|iPad|Tablet/.test(t)||(c="Desktop");var s="Unknown";return/Windows/.test(t)?s="Windows":/Mac OS/.test(t)?s="macOS":/Linux/.test(t)?s="Linux":/Android/.test(t)?s="Android":/iOS/.test(t)&&(s="iOS"),{browser:e,browserVersion:n,device:c,os:s}},b=function(){return n(void 0,void 0,void 0,(function(){var t,e,n,r;return o(this,(function(o){switch(o.label){case 0:return t=document.referrer||"Direct",e=navigator.userAgent,n=y(e),f?[3,2]:[4,T()];case 1:f=o.sent(),o.label=2;case 2:return r={referrerUrl:t,refererDomain:"Direct"!==t?new URL(t).hostname:"",entryUrl:window.location.href,siteUrl:window.location.origin,userAgent:e,browser:n.browser,browserVersion:n.browserVersion,deviceType:n.device,operatingSystem:n.os,platform:navigator.platform,screenSize:"".concat(screen.width,"x").concat(screen.height),language:navigator.language,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,sourceCode:"direct",channelCode:"direct",campaignCode:"",affiliateCode:"",clientIp:"",city:(null==f?void 0:f.city)||"Unknown",region:(null==f?void 0:f.region)||"Unknown",country:(null==f?void 0:f.country)||"Unknown",isp:(null==f?void 0:f.isp)||"Unknown",connectionType:(null==f?void 0:f.connectionType)||"Unknown",comments:"",customField1:"",customField2:"",customField3:"",customField4:"",customField5:""},console.log("Generated enhanced tracking info with proper affiliate code:",r),[2,r]}}))}))},k=function(){function t(t,e,n){this.batchTimer=null,this.siteId=t,this.apiEndpoint=e,this.config={affiliateAttributionMode:(null==n?void 0:n.affiliateAttributionMode)||l,cookieExpireDays:(null==n?void 0:n.cookieExpireDays)||30,sessionTimeout:(null==n?void 0:n.sessionTimeout)||u,batchSendInterval:(null==n?void 0:n.batchSendInterval)||3e4,enableGeolocation:void 0===(null==n?void 0:n.enableGeolocation)||n.enableGeolocation},p=this.config,console.log("VisitorTracker initialized with config:",this.config),this.visitorUUID=v("trk_visitor_uuid")||s(),m("trk_visitor_uuid",this.visitorUUID,365),this.sessionId=v("trk_session_id")||"".concat(this.visitorUUID,"_").concat(Date.now()),m("trk_session_id",this.sessionId),m("trk_session_timestamp",Date.now().toString()),localStorage.getItem(d)||localStorage.setItem(d,Date.now().toString()),localStorage.setItem("trk_session_start",Date.now().toString()),this.initializeTracking(),window.crmTracker=this}return t.prototype.initializeTracking=function(){return n(this,void 0,void 0,(function(){var t;return o(this,(function(e){switch(e.label){case 0:if(!this.config.enableGeolocation)return[3,4];e.label=1;case 1:return e.trys.push([1,3,,4]),[4,n(void 0,void 0,void 0,(function(){var t,e;return o(this,(function(n){switch(n.label){case 0:if(!p.enableGeolocation)return console.log("Geolocation capture disabled in configuration"),[2,null];n.label=1;case 1:return n.trys.push([1,3,,4]),[4,T()];case 2:return t=n.sent(),[2,new Promise((function(e){if(!navigator.geolocation)return console.log("Geolocation API not supported"),void e({latitude:0,longitude:0,accuracy:0,timestamp:Date.now(),city:(null==t?void 0:t.city)||"Unknown",region:(null==t?void 0:t.region)||"Unknown",country:(null==t?void 0:t.country)||"Unknown"});console.log("Requesting geolocation permission..."),navigator.geolocation.getCurrentPosition((function(n){var o={latitude:n.coords.latitude,longitude:n.coords.longitude,accuracy:n.coords.accuracy,timestamp:Date.now(),city:(null==t?void 0:t.city)||"Unknown",region:(null==t?void 0:t.region)||"Unknown",country:(null==t?void 0:t.country)||"Unknown"};console.log("Geolocation captured successfully:",o),g=o,e(o)}),(function(n){console.log("Geolocation error:",n.code,n.message),e({latitude:0,longitude:0,accuracy:0,timestamp:Date.now(),city:(null==t?void 0:t.city)||"Unknown",region:(null==t?void 0:t.region)||"Unknown",country:(null==t?void 0:t.country)||"Unknown"})}))}))];case 3:return e=n.sent(),console.error("Error in geolocation capture:",e),[2,{latitude:0,longitude:0,accuracy:0,timestamp:Date.now(),city:"Unknown",region:"Unknown",country:"Unknown"}];case 4:return[2]}}))}))];case 2:return e.sent(),[3,4];case 3:return t=e.sent(),console.error("Failed to capture geolocation:",t),[3,4];case 4:return[4,this.trackPageView()];case 5:return e.sent(),this.startBatchTimer(),[2]}}))}))},t.prototype.trackPageView=function(){return n(this,void 0,void 0,(function(){var t,e;return o(this,(function(n){switch(n.label){case 0:return t={pageUrl:window.location.href,timestamp:Date.now(),screenSize:"".concat(screen.width,"x").concat(screen.height),language:navigator.language,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,pageTitle:document.title},[4,this.getCurrentBatch()];case 1:(e=n.sent()).visits.push(t);try{localStorage.setItem("trk_tracking_batch",JSON.stringify(e))}catch(t){console.error("Error saving tracking batch:",t)}return[2]}}))}))},t.prototype.getCurrentBatch=function(){return n(this,void 0,void 0,(function(){var t,e,n,r,i;return o(this,(function(o){switch(o.label){case 0:return o.trys.push([0,4,,5]),(t=localStorage.getItem("trk_tracking_batch"))?(e=JSON.parse(t)).trackingInfo.isp&&e.trackingInfo.city?[3,2]:(n=e,[4,b()]):[3,3];case 1:n.trackingInfo=o.sent(),o.label=2;case 2:return[2,e];case 3:return[3,5];case 4:return r=o.sent(),console.error("Error parsing stored batch:",r),[3,5];case 5:return i={siteId:this.siteId,visitorUUID:this.visitorUUID,sessionId:this.sessionId,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone},[4,b()];case 6:return i.trackingInfo=o.sent(),i.utmParameter=(a=new URLSearchParams(window.location.search),c={source:a.get("utm_source")||a.get("utm-source")||"Not set",medium:a.get("utm_medium")||a.get("utm-medium")||"Not set",campaign:a.get("utm_campaign")||a.get("utm-campaign")||"Not set",term:a.get("utm_term")||a.get("utm-term")||"Not set",content:a.get("utm_content")||a.get("utm-content")||"Not set",keyword:a.get("utm_keyword")||a.get("utm-keyword")||"Not set",adGroup:a.get("utm_adgroup")||a.get("utm-adgroup")||"Not set",name:a.get("utm_name")||a.get("utm-name")||"Not set"},console.log("Parsed UTM parameters:",c),c),i.visits=[],i.geolocation=g||{latitude:0,longitude:0,accuracy:0,timestamp:Date.now(),city:"Unknown",region:"Unknown",country:"Unknown"},[2,i]}var a,c}))}))},t.prototype.sendBatch=function(){return n(this,void 0,void 0,(function(){var t,e,n;return o(this,(function(o){switch(o.label){case 0:return[4,this.getCurrentBatch()];case 1:if(!(t=o.sent()).visits.length)return console.log("No visits to send in batch"),[2];console.log("Sending enhanced CRM-compatible batch:",t),o.label=2;case 2:return o.trys.push([2,4,,5]),[4,fetch(this.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})];case 3:return(e=o.sent()).ok?(console.log("Tracking batch sent successfully"),localStorage.removeItem("trk_tracking_batch")):console.error("Failed to send tracking batch - HTTP status:",e.status),[3,5];case 4:return n=o.sent(),console.error("Failed to send tracking batch:",n),[3,5];case 5:return[2]}}))}))},t.prototype.startBatchTimer=function(){var t=this;this.batchTimer=setInterval((function(){t.sendBatch()}),this.config.batchSendInterval)},t.prototype.getVisitorUUID=function(){return this.visitorUUID},t.prototype.getSessionId=function(){return this.sessionId},t.prototype.destroy=function(){this.batchTimer&&(clearInterval(this.batchTimer),this.batchTimer=null)},t.prototype.getConfig=function(){return e({},this.config)},t.prototype.updateConfig=function(t){this.config=e(e({},this.config),t),p=this.config,t.batchSendInterval&&this.batchTimer&&(clearInterval(this.batchTimer),this.startBatchTimer()),console.log("Configuration updated:",this.config)},t}(),U=function(t,e,n){return console.log("Initializing comprehensive tracking system with config:",n),new k(t,e,n)},I=function(){var t=v("affiliateRefCode")||localStorage.getItem("affiliateRefCode")||"";return{ip:"",location:f||{},geolocation:g||{latitude:0,longitude:0,accuracy:0,timestamp:0},sources:h,userAgent:navigator.userAgent,clientIp:"",platform:navigator.platform,language:navigator.language,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,screenResolution:"".concat(screen.width,"x").concat(screen.height),referrer:document.referrer,entryUrl:window.location.href,locationData:f||{},affiliateRefCode:t}},T=function(t){return n(void 0,void 0,void 0,(function(){var e,n,r;return o(this,(function(o){switch(o.label){case 0:if(!t)return[2,f||{}];o.label=1;case 1:return o.trys.push([1,4,,5]),[4,fetch("https://ipapi.co/".concat(t,"/json/"))];case 2:return[4,o.sent().json()];case 3:return e=o.sent(),n={city:e.city,region:e.region,country:e.country_name,isp:e.org,connectionType:e.connection_type||"Unknown",connection:e.connection_type||"Unknown"},f=n,[2,n];case 4:return r=o.sent(),console.error("Failed to fetch location data:",r),[2,f||{}];case 5:return[2]}}))}))},S=function(){var t;try{var e=localStorage.getItem("trk_tracking_batch");if(e)return(null===(t=JSON.parse(e).visits)||void 0===t?void 0:t.map((function(t){return t.pageUrl})))||[]}catch(t){console.error("Error getting pages visited:",t)}return[]},D=function(){return S().length};"undefined"!=typeof window&&(window.VisitorTracker=k,window.initializeTracking=U,window.fetchUserIP=w,window.getUserTrackingData=I,window.fetchLocationData=T,window.getPagesVisited=S,window.getPageCount=D),t.VisitorTracker=k,t.fetchLocationData=T,t.fetchUserIP=w,t.getCookie=v,t.getPageCount=D,t.getPagesVisited=S,t.getUserTrackingData=I,t.initializeTracking=U,t.parseUserAgent=y,t.setCookie=m,Object.defineProperty(t,"__esModule",{value:!0})}));
