!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).VisitorTracker={})}(this,(function(t){"use strict";function e(t,e,o,n){return new(o||(o=Promise))((function(i,r){function a(t){try{c(n.next(t))}catch(t){r(t)}}function s(t){try{c(n.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?i(t.value):(e=t.value,e instanceof o?e:new o((function(t){t(e)}))).then(a,s)}c((n=n.apply(t,e||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;const o=[];for(let t=0;t<256;++t)o.push((t+256).toString(16).slice(1));let n;const i=new Uint8Array(16);var r={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function a(t,e,a){if(r.randomUUID&&!e&&!t)return r.randomUUID();const s=(t=t||{}).random??t.rng?.()??function(){if(!n){if("undefined"==typeof crypto||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");n=crypto.getRandomValues.bind(crypto)}return n(i)}();if(s.length<16)throw new Error("Random bytes length must be >= 16");if(s[6]=15&s[6]|64,s[8]=63&s[8]|128,e){if((a=a||0)<0||a+16>e.length)throw new RangeError(`UUID byte range ${a}:${a+15} is out of buffer bounds`);for(let t=0;t<16;++t)e[a+t]=s[t];return e}return function(t,e=0){return(o[t[e+0]]+o[t[e+1]]+o[t[e+2]]+o[t[e+3]]+"-"+o[t[e+4]]+o[t[e+5]]+"-"+o[t[e+6]]+o[t[e+7]]+"-"+o[t[e+8]]+o[t[e+9]]+"-"+o[t[e+10]]+o[t[e+11]]+o[t[e+12]]+o[t[e+13]]+o[t[e+14]]+o[t[e+15]]).toLowerCase()}(s)}const s=36e5,c="first-visit",l="trk_first_visit";let d=null,u=null,g=[],m={affiliateAttributionMode:c,cookieExpireDays:30,sessionTimeout:s,batchSendInterval:3e4,enableGeolocation:!0};const h=(t,e,o)=>{const n=o||m.cookieExpireDays,i=new Date;i.setTime(i.getTime()+24*n*60*60*1e3),document.cookie=`${t}=${e};expires=${i.toUTCString()};path=/;SameSite=Lax`},f=t=>{var e;const o=`; ${document.cookie}`.split(`; ${t}=`);return 2===o.length&&(null===(e=o.pop())||void 0===e?void 0:e.split(";").shift())||""},p=()=>e(void 0,void 0,void 0,(function*(){try{const t=yield fetch("https://api.ipify.org?format=json");return(yield t.json()).ip}catch(t){return console.error("Failed to fetch user IP:",t),"Unknown"}})),y=t=>{const e=[{name:"Chrome",regex:/Chrome\/([0-9.]+)/},{name:"Firefox",regex:/Firefox\/([0-9.]+)/},{name:"Safari",regex:/Safari\/([0-9.]+)/},{name:"Edge",regex:/Edge\/([0-9.]+)/},{name:"Opera",regex:/Opera\/([0-9.]+)/}];let o="Unknown",n="";for(const i of e){const e=t.match(i.regex);if(e){o=i.name,n=e[1];break}}let i="Unknown";/Mobile|Android|iPhone/.test(t)?i="Mobile":/iPad|Tablet/.test(t)?i="Tablet":/Mobile|Android|iPhone|iPad|Tablet/.test(t)||(i="Desktop");let r="Unknown";return/Windows/.test(t)?r="Windows":/Mac OS/.test(t)?r="macOS":/Linux/.test(t)?r="Linux":/Android/.test(t)?r="Android":/iOS/.test(t)&&(r="iOS"),{browser:o,browserVersion:n,device:i,os:r}},w=()=>e(void 0,void 0,void 0,(function*(){const t=document.referrer||"Direct",e=navigator.userAgent,o=y(e);u||(u=yield I());const n={referrerUrl:t,refererDomain:"Direct"!==t?new URL(t).hostname:"",entryUrl:window.location.href,siteUrl:window.location.origin,userAgent:e,browser:o.browser,browserVersion:o.browserVersion,deviceType:o.device,operatingSystem:o.os,platform:navigator.platform,screenSize:`${screen.width}x${screen.height}`,language:navigator.language,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,sourceCode:"direct",channelCode:"direct",campaignCode:"",affiliateCode:"",clientIp:"",city:(null==u?void 0:u.city)||"Unknown",region:(null==u?void 0:u.region)||"Unknown",country:(null==u?void 0:u.country)||"Unknown",isp:(null==u?void 0:u.isp)||"Unknown",connectionType:(null==u?void 0:u.connectionType)||"Unknown",comments:"",customField1:"",customField2:"",customField3:"",customField4:"",customField5:""};return console.log("Generated enhanced tracking info with proper affiliate code:",n),n})),v=()=>{const t=new URLSearchParams(window.location.search),e={source:t.get("utm_source")||t.get("utm-source")||"Not set",medium:t.get("utm_medium")||t.get("utm-medium")||"Not set",campaign:t.get("utm_campaign")||t.get("utm-campaign")||"Not set",term:t.get("utm_term")||t.get("utm-term")||"Not set",content:t.get("utm_content")||t.get("utm-content")||"Not set",keyword:t.get("utm_keyword")||t.get("utm-keyword")||"Not set",adGroup:t.get("utm_adgroup")||t.get("utm-adgroup")||"Not set",name:t.get("utm_name")||t.get("utm-name")||"Not set"};return console.log("Parsed UTM parameters:",e),e};class k{constructor(t,e,o){this.batchTimer=null,this.siteId=t,this.apiEndpoint=e,this.config={affiliateAttributionMode:(null==o?void 0:o.affiliateAttributionMode)||c,cookieExpireDays:(null==o?void 0:o.cookieExpireDays)||30,sessionTimeout:(null==o?void 0:o.sessionTimeout)||s,batchSendInterval:(null==o?void 0:o.batchSendInterval)||3e4,enableGeolocation:void 0===(null==o?void 0:o.enableGeolocation)||o.enableGeolocation},m=this.config,console.log("VisitorTracker initialized with config:",this.config),this.visitorUUID=f("trk_visitor_uuid")||a(),h("trk_visitor_uuid",this.visitorUUID,365),this.sessionId=f("trk_session_id")||`${this.visitorUUID}_${Date.now()}`,h("trk_session_id",this.sessionId),h("trk_session_timestamp",Date.now().toString()),localStorage.getItem(l)||localStorage.setItem(l,Date.now().toString()),localStorage.setItem("trk_session_start",Date.now().toString()),this.initializeTracking(),window.crmTracker=this}initializeTracking(){return e(this,void 0,void 0,(function*(){if(this.config.enableGeolocation)try{yield e(void 0,void 0,void 0,(function*(){if(!m.enableGeolocation)return console.log("Geolocation capture disabled in configuration"),null;try{const t=yield I();return new Promise((e=>{if(!navigator.geolocation)return console.log("Geolocation API not supported"),void e({latitude:0,longitude:0,accuracy:0,timestamp:Date.now(),city:(null==t?void 0:t.city)||"Unknown",region:(null==t?void 0:t.region)||"Unknown",country:(null==t?void 0:t.country)||"Unknown"});console.log("Requesting geolocation permission..."),navigator.geolocation.getCurrentPosition((o=>{const n={latitude:o.coords.latitude,longitude:o.coords.longitude,accuracy:o.coords.accuracy,timestamp:Date.now(),city:(null==t?void 0:t.city)||"Unknown",region:(null==t?void 0:t.region)||"Unknown",country:(null==t?void 0:t.country)||"Unknown"};console.log("Geolocation captured successfully:",n),d=n,e(n)}),(o=>{console.log("Geolocation error:",o.code,o.message),e({latitude:0,longitude:0,accuracy:0,timestamp:Date.now(),city:(null==t?void 0:t.city)||"Unknown",region:(null==t?void 0:t.region)||"Unknown",country:(null==t?void 0:t.country)||"Unknown"})}))}))}catch(t){return console.error("Error in geolocation capture:",t),{latitude:0,longitude:0,accuracy:0,timestamp:Date.now(),city:"Unknown",region:"Unknown",country:"Unknown"}}}))}catch(t){console.error("Failed to capture geolocation:",t)}yield this.trackPageView(),this.startBatchTimer()}))}trackPageView(){return e(this,void 0,void 0,(function*(){const t={pageUrl:window.location.href,timestamp:Date.now(),screenSize:`${screen.width}x${screen.height}`,language:navigator.language,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,pageTitle:document.title},e=yield this.getCurrentBatch();e.visits.push(t);try{localStorage.setItem("trk_tracking_batch",JSON.stringify(e))}catch(t){console.error("Error saving tracking batch:",t)}}))}getCurrentBatch(){return e(this,void 0,void 0,(function*(){try{const t=localStorage.getItem("trk_tracking_batch");if(t){const e=JSON.parse(t);return e.trackingInfo.isp&&e.trackingInfo.city||(e.trackingInfo=yield w()),e}}catch(t){console.error("Error parsing stored batch:",t)}return{siteId:this.siteId,visitorUUID:this.visitorUUID,sessionId:this.sessionId,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,trackingInfo:yield w(),utmParameter:v(),visits:[],geolocation:d||{latitude:0,longitude:0,accuracy:0,timestamp:Date.now(),city:"Unknown",region:"Unknown",country:"Unknown"}}}))}sendBatch(){return e(this,void 0,void 0,(function*(){const t=yield this.getCurrentBatch();if(t.visits.length){console.log("Sending enhanced CRM-compatible batch:",t);try{const e=yield fetch(this.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});e.ok?(console.log("Tracking batch sent successfully"),localStorage.removeItem("trk_tracking_batch")):console.error("Failed to send tracking batch - HTTP status:",e.status)}catch(t){console.error("Failed to send tracking batch:",t)}}else console.log("No visits to send in batch")}))}startBatchTimer(){this.batchTimer=setInterval((()=>{this.sendBatch()}),this.config.batchSendInterval)}getVisitorUUID(){return this.visitorUUID}getSessionId(){return this.sessionId}destroy(){this.batchTimer&&(clearInterval(this.batchTimer),this.batchTimer=null)}getConfig(){return Object.assign({},this.config)}updateConfig(t){this.config=Object.assign(Object.assign({},this.config),t),m=this.config,t.batchSendInterval&&this.batchTimer&&(clearInterval(this.batchTimer),this.startBatchTimer()),console.log("Configuration updated:",this.config)}}const U=(t,e,o)=>(console.log("Initializing comprehensive tracking system with config:",o),new k(t,e,o)),b=()=>{const t=f("affiliateRefCode")||localStorage.getItem("affiliateRefCode")||"";return{ip:"",location:u||{},geolocation:d||{latitude:0,longitude:0,accuracy:0,timestamp:0},sources:g,userAgent:navigator.userAgent,clientIp:"",platform:navigator.platform,language:navigator.language,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,screenResolution:`${screen.width}x${screen.height}`,referrer:document.referrer,entryUrl:window.location.href,locationData:u||{},affiliateRefCode:t}},I=t=>e(void 0,void 0,void 0,(function*(){if(!t)return u||{};try{const e=yield fetch(`https://ipapi.co/${t}/json/`),o=yield e.json(),n={city:o.city,region:o.region,country:o.country_name,isp:o.org,connectionType:o.connection_type||"Unknown",connection:o.connection_type||"Unknown"};return u=n,n}catch(t){return console.error("Failed to fetch location data:",t),u||{}}})),T=()=>{var t;try{const e=localStorage.getItem("trk_tracking_batch");if(e){return(null===(t=JSON.parse(e).visits)||void 0===t?void 0:t.map((t=>t.pageUrl)))||[]}}catch(t){console.error("Error getting pages visited:",t)}return[]},D=()=>T().length;"undefined"!=typeof window&&(window.VisitorTracker=k,window.initializeTracking=U,window.fetchUserIP=p,window.getUserTrackingData=b,window.fetchLocationData=I,window.getPagesVisited=T,window.getPageCount=D),t.VisitorTracker=k,t.fetchLocationData=I,t.fetchUserIP=p,t.getCookie=f,t.getPageCount=D,t.getPagesVisited=T,t.getUserTrackingData=b,t.initializeTracking=U,t.parseUserAgent=y,t.setCookie=h,Object.defineProperty(t,"__esModule",{value:!0})}));
