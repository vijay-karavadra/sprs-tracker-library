!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("react")):"function"==typeof define&&define.amd?define(["exports","react"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).VisitorTracker={},e.React)}(this,(function(e,t){"use strict";function o(e,t,o,n){return new(o||(o=Promise))((function(i,r){function a(e){try{s(n.next(e))}catch(e){r(e)}}function c(e){try{s(n.throw(e))}catch(e){r(e)}}function s(e){var t;e.done?i(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,c)}s((n=n.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;const n=[];for(let e=0;e<256;++e)n.push((e+256).toString(16).slice(1));let i;const r=new Uint8Array(16);var a={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function c(e,t,o){if(a.randomUUID&&!t&&!e)return a.randomUUID();const c=(e=e||{}).random??e.rng?.()??function(){if(!i){if("undefined"==typeof crypto||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");i=crypto.getRandomValues.bind(crypto)}return i(r)}();if(c.length<16)throw new Error("Random bytes length must be >= 16");if(c[6]=15&c[6]|64,c[8]=63&c[8]|128,t){if((o=o||0)<0||o+16>t.length)throw new RangeError(`UUID byte range ${o}:${o+15} is out of buffer bounds`);for(let e=0;e<16;++e)t[o+e]=c[e];return t}return function(e,t=0){return(n[e[t+0]]+n[e[t+1]]+n[e[t+2]]+n[e[t+3]]+"-"+n[e[t+4]]+n[e[t+5]]+"-"+n[e[t+6]]+n[e[t+7]]+"-"+n[e[t+8]]+n[e[t+9]]+"-"+n[e[t+10]]+n[e[t+11]]+n[e[t+12]]+n[e[t+13]]+n[e[t+14]]+n[e[t+15]]).toLowerCase()}(c)}var s={enableGeolocation:!0,batchSendInterval:3e4};const l=36e5,d="first-visit",u="trk_first_visit";let g="",m=null,f=null,h=[],p={affiliateAttributionMode:d,cookieExpireDays:30,sessionTimeout:l,batchSendInterval:3e4,enableGeolocation:!0};const y=(e,t,o)=>{const n=o||p.cookieExpireDays,i=new Date;i.setTime(i.getTime()+24*n*60*60*1e3),document.cookie=`${e}=${t};expires=${i.toUTCString()};path=/;SameSite=Lax`},w=e=>{var t;const o=`; ${document.cookie}`.split(`; ${e}=`);return 2===o.length&&(null===(t=o.pop())||void 0===t?void 0:t.split(";").shift())||""},v=()=>o(void 0,void 0,void 0,(function*(){try{const e=yield fetch("https://api.ipify.org?format=json");return(yield e.json()).ip}catch(e){return console.error("Failed to fetch user IP:",e),"Unknown"}})),k=e=>{const t=[{name:"Chrome",regex:/Chrome\/([0-9.]+)/},{name:"Firefox",regex:/Firefox\/([0-9.]+)/},{name:"Safari",regex:/Safari\/([0-9.]+)/},{name:"Edge",regex:/Edge\/([0-9.]+)/},{name:"Opera",regex:/Opera\/([0-9.]+)/}];let o="Unknown",n="";for(const i of t){const t=e.match(i.regex);if(t){o=i.name,n=t[1];break}}let i="Unknown";/Mobile|Android|iPhone/.test(e)?i="Mobile":/iPad|Tablet/.test(e)?i="Tablet":/Mobile|Android|iPhone|iPad|Tablet/.test(e)||(i="Desktop");let r="Unknown";return/Windows/.test(e)?r="Windows":/Mac OS/.test(e)?r="macOS":/Linux/.test(e)?r="Linux":/Android/.test(e)?r="Android":/iOS/.test(e)&&(r="iOS"),{browser:o,browserVersion:n,device:i,os:r}},b=()=>o(void 0,void 0,void 0,(function*(){const e=document.referrer||"Direct",t=navigator.userAgent,o=k(t);f||(f=yield D());const n={referrerUrl:e,refererDomain:"Direct"!==e?new URL(e).hostname:"",entryUrl:window.location.href,siteUrl:window.location.origin,userAgent:t,browser:o.browser,browserVersion:o.browserVersion,deviceType:o.device,operatingSystem:o.os,platform:navigator.platform,screenSize:`${screen.width}x${screen.height}`,language:navigator.language,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,sourceCode:"direct",channelCode:"direct",campaignCode:"",affiliateCode:"",clientIp:g,city:(null==f?void 0:f.city)||"Unknown",region:(null==f?void 0:f.region)||"Unknown",country:(null==f?void 0:f.country)||"Unknown",isp:(null==f?void 0:f.isp)||"Unknown",connectionType:(null==f?void 0:f.connectionType)||"Unknown",comments:"",customField1:"",customField2:"",customField3:"",customField4:"",customField5:""};return console.log("Generated enhanced tracking info with proper affiliate code:",n),n})),U=()=>{const e=new URLSearchParams(window.location.search),t={source:e.get("utm_source")||e.get("utm-source")||"Not set",medium:e.get("utm_medium")||e.get("utm-medium")||"Not set",campaign:e.get("utm_campaign")||e.get("utm-campaign")||"Not set",term:e.get("utm_term")||e.get("utm-term")||"Not set",content:e.get("utm_content")||e.get("utm-content")||"Not set",keyword:e.get("utm_keyword")||e.get("utm-keyword")||"Not set",adGroup:e.get("utm_adgroup")||e.get("utm-adgroup")||"Not set",name:e.get("utm_name")||e.get("utm-name")||"Not set"};return console.log("Parsed UTM parameters:",t),t};class I{constructor(e,t,o){this.batchTimer=null,this.siteId=e,this.apiEndpoint=t,this.config={affiliateAttributionMode:(null==o?void 0:o.affiliateAttributionMode)||d,cookieExpireDays:(null==o?void 0:o.cookieExpireDays)||30,sessionTimeout:(null==o?void 0:o.sessionTimeout)||l,batchSendInterval:(null==o?void 0:o.batchSendInterval)||3e4,enableGeolocation:void 0===(null==o?void 0:o.enableGeolocation)||o.enableGeolocation},p=this.config,console.log("VisitorTracker initialized with config:",this.config),this.visitorUUID=w("trk_visitor_uuid")||c(),y("trk_visitor_uuid",this.visitorUUID,365),this.sessionId=w("trk_session_id")||`${this.visitorUUID}_${Date.now()}`,y("trk_session_id",this.sessionId),y("trk_session_timestamp",Date.now().toString()),localStorage.getItem(u)||localStorage.setItem(u,Date.now().toString()),localStorage.setItem("trk_session_start",Date.now().toString()),this.initializeTracking(),window.crmTracker=this}initializeTracking(){return o(this,void 0,void 0,(function*(){if(this.config.enableGeolocation)try{m=yield o(void 0,void 0,void 0,(function*(){if(!p.enableGeolocation)return console.log("Geolocation capture disabled in configuration"),null;try{g||(g=yield v());const e=yield D(g);return new Promise((t=>{if(!navigator.geolocation){console.log("Geolocation API not supported");const o={latitude:0,longitude:0,accuracy:0,timestamp:Date.now(),city:(null==e?void 0:e.city)||"Unknown",region:(null==e?void 0:e.region)||"Unknown",country:(null==e?void 0:e.country)||"Unknown"};return m=o,void t(o)}console.log("Requesting geolocation permission..."),navigator.geolocation.getCurrentPosition((o=>{let n=o.coords.latitude,i=o.coords.longitude,r=o.coords.accuracy;const a=!n&&!i||"number"==typeof n&&"number"==typeof i&&0===n&&0===i,c={latitude:a?0:n,longitude:a?0:i,accuracy:a?0:r,timestamp:Date.now(),city:(null==e?void 0:e.city)||"Unknown",region:(null==e?void 0:e.region)||"Unknown",country:(null==e?void 0:e.country)||"Unknown"};console.log("Geolocation captured (with fallback if needed):",c),m=c,t(c)}),(o=>{console.log("Geolocation error:",o.code,o.message);const n={latitude:0,longitude:0,accuracy:0,timestamp:Date.now(),city:(null==e?void 0:e.city)||"Unknown",region:(null==e?void 0:e.region)||"Unknown",country:(null==e?void 0:e.country)||"Unknown"};m=n,t(n)}))}))}catch(e){console.error("Error in geolocation capture:",e);const t={latitude:0,longitude:0,accuracy:0,timestamp:Date.now(),city:"Unknown",region:"Unknown",country:"Unknown"};return m=t,t}}))}catch(e){console.error("Failed to capture geolocation:",e)}yield this.trackPageView(),this.startBatchTimer()}))}trackPageView(){return o(this,void 0,void 0,(function*(){const e={pageUrl:window.location.href,timestamp:Date.now(),screenSize:`${screen.width}x${screen.height}`,language:navigator.language,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,pageTitle:document.title},t=yield this.getCurrentBatch();t.visits.push(e);try{localStorage.setItem("trk_tracking_batch",JSON.stringify(t))}catch(e){console.error("Error saving tracking batch:",e)}}))}getCurrentBatch(){return o(this,void 0,void 0,(function*(){try{const e=localStorage.getItem("trk_tracking_batch");if(e){const t=JSON.parse(e);return t.trackingInfo.isp&&t.trackingInfo.city||(t.trackingInfo=yield b()),t}}catch(e){console.error("Error parsing stored batch:",e)}return{siteId:this.siteId,visitorUUID:this.visitorUUID,sessionId:this.sessionId,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,trackingInfo:yield b(),utmParameter:U(),visits:[],geolocation:m||{latitude:0,longitude:0,accuracy:0,timestamp:Date.now(),city:"Unknown",region:"Unknown",country:"Unknown"}}}))}sendBatch(){return o(this,void 0,void 0,(function*(){const e=yield this.getCurrentBatch();if(e.visits.length){console.log("Sending enhanced CRM-compatible batch:",e);try{const t=yield fetch(this.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});t.ok?(console.log("Tracking batch sent successfully"),localStorage.removeItem("trk_tracking_batch")):console.error("Failed to send tracking batch - HTTP status:",t.status)}catch(e){console.error("Failed to send tracking batch:",e)}}else console.log("No visits to send in batch")}))}startBatchTimer(){this.batchTimer=setInterval((()=>{this.sendBatch()}),this.config.batchSendInterval)}getVisitorUUID(){return this.visitorUUID}getSessionId(){return this.sessionId}destroy(){this.batchTimer&&(clearInterval(this.batchTimer),this.batchTimer=null)}getConfig(){return Object.assign({},this.config)}updateConfig(e){this.config=Object.assign(Object.assign({},this.config),e),p=this.config,e.batchSendInterval&&this.batchTimer&&(clearInterval(this.batchTimer),this.startBatchTimer()),console.log("Configuration updated:",this.config)}}const T=(e,t,o)=>(console.log("Initializing comprehensive tracking system with config:",o),new I(e,t,o)),S=()=>{const e=w("affiliateRefCode")||localStorage.getItem("affiliateRefCode")||"";return{ip:g,location:f||{},geolocation:m||{latitude:0,longitude:0,accuracy:0,timestamp:0},sources:h,userAgent:navigator.userAgent,clientIp:g,platform:navigator.platform,language:navigator.language,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,screenResolution:`${screen.width}x${screen.height}`,referrer:document.referrer,entryUrl:window.location.href,locationData:f||{},affiliateRefCode:e}},D=e=>o(void 0,void 0,void 0,(function*(){if(!e)return f||{};try{const t=yield fetch(`https://ipapi.co/${e}/json/`),o=yield t.json(),n={city:o.city,region:o.region,country:o.country_name,isp:o.org,connectionType:o.connection_type||"Unknown",connection:o.connection_type||"Unknown"};return f=n,n}catch(e){return console.error("Failed to fetch location data:",e),f||{}}})),_=()=>{var e;try{const t=localStorage.getItem("trk_tracking_batch");if(t){return(null===(e=JSON.parse(t).visits)||void 0===e?void 0:e.map((e=>e.pageUrl)))||[]}}catch(e){console.error("Error getting pages visited:",e)}return[]},O=()=>_().length;"undefined"!=typeof window&&(window.VisitorTracker=I,window.initializeTracking=T,window.fetchUserIP=v,window.getUserTrackingData=S,window.fetchLocationData=D,window.getPagesVisited=_,window.getPageCount=O),e.VisitorTracker=I,e.fetchLocationData=D,e.fetchUserIP=v,e.getCookie=w,e.getPageCount=O,e.getPagesVisited=_,e.getUserTrackingData=S,e.initializeTracking=T,e.parseUserAgent=k,e.setCookie=y,e.useTracker=function(e,o){const[n,i]=t.useState(null);return t.useEffect((()=>{if("undefined"!=typeof window){const t=function(e,t){var o={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(o[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(n=Object.getOwnPropertySymbols(e);i<n.length;i++)t.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(o[n[i]]=e[n[i]])}return o}(s,[]),n=new I(e,o,t);return i(n),()=>{n.destroy()}}}),[]),n},Object.defineProperty(e,"__esModule",{value:!0})}));
